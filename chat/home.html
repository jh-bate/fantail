<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
$(function() {
//variables
  var conn;
  var note = $("#noteText");
  var smbg = $("#smbgText");
  var log = $("#log");
//log messages
  function appendLog(msg) {
      var d = log[0]
      var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
      msg.appendTo(log)
      if (doScroll) {
          d.scrollTop = d.scrollHeight - d.clientHeight;
      }
  }
//login
  $( "#login" ).submit(function( event ) {
    event.preventDefault();

    var un = $("#un").val();
    var pw = $("#pw").val();
    //reset
    $("#un").val("");
    $("#pw").val("");

    var post = $.ajax
    ({
      type: "POST",
      url: "/login",
      dataType: 'json',
      async: false,
      headers: {
        "Authorization": "Basic " + btoa(un + ":" + pw)
      }
    });

    if (post.getResponseHeader('X-Fantail-Token') !== ""){
      localStorage.setItem('x-fantail-token', post.getResponseHeader('x-fantail-token'));
    }
  });
//notes
  $("#note").submit(function() {
      if (!conn) {
        return false;
      }
      if (!note.val()) {
        return false;
      }
      if (localStorage.getItem('x-fantail-token') === null) {
        return false;
      }

      conn.send(JSON.stringify({
        type: 'note',
        user: localStorage.getItem('x-fantail-token'),
        text: note.val(),
        time: new Date().toISOString()
      }));
      note.val("");
      return false
  });
//bgs
  $("#bg").submit(function() {
      if (!conn) {
          return false;
      }
      if (!smbg.val()) {
          return false;
      }
      if (localStorage.getItem('x-fantail-token') === null) {
        return false;
      }

      console.log('saving smbg',smbg.val());

      conn.send(JSON.stringify({
        type: 'smbg',
        text: smbg.val(),
        user: localStorage.getItem('x-fantail-token'),
        time: new Date().toISOString()
      }));

      smbg.val("");
      return false
  });
//setup
  if (window["WebSocket"]) {
    conn = new WebSocket("ws://{{$}}/ws");
    conn.onclose = function(evt) {
        appendLog($("<h2>Connection closed.</h2>"))
    }
    conn.onmessage = function(evt) {
        appendLog($("<div/>").text(evt.data))
    }
  } else {
      appendLog($("<h2>Your browser does not support WebSockets.</h2>"))
  }
});
</script>
<style type="text/css">

input[type=submit]{background:#0b9eb3;color:#fff;}
input{height:37px;margin:5px;font-size:18px;}
body{margin:40px auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}

#login {
position: absolute;
top: 1em;
left: 0.5em;
overflow: auto;
}

#log {
position: absolute;
top: 3em;
left: 0.5em;
right: 0.5em;
bottom: 3em;
overflow: auto;
}

#note {
position: absolute;
bottom: 1em;
left: 0px;
overflow: auto;
}

#bg {
position: absolute;
bottom: 1em;
right: 0px;
overflow: auto;
}

</style>
</head>
<body>
  <form id="login">
    <input type="text" id="un" placeholder="username" />
    <input type="password" id="pw" placeholder="password" />
    <input type="submit" value="Login" />
  </form>
  <div id="app">
    <div id="log"></div>
    <form id="bg">
      <input type="submit" value="+bg" />
      <input type="text" id="smbgText" placeholder="add your bg e.g. 10.7" size="64"/>
    </form>
    <form id="note">
      <input type="submit" value="+note" />
      <input type="text" id="noteText" placeholder="add a note" size="64"/>
    </form>
  </div>
</body>
</html>
