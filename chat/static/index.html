<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
$(function() {
//variables
  var conn;
  var note = $("#noteText");
  var smbg = $("#smbgText");
  var log = $("#log");
//log messages
  function appendLog(msg) {
      var d = log[0]
      var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
      msg.appendTo(log)
      if (doScroll) {
          d.scrollTop = d.scrollHeight - d.clientHeight;
      }
  }
  /*
   * Authorisation
   */
  // Logout
  $( "#logout" ).click(function( event ) {
    event.preventDefault();
    localStorage.setItem('x-fantail-token',null);
    $('#auth').removeClass('hidden').addClass('visible');
    $('#app').removeClass('visible').addClass('hidden');
    return false;
  });
  // Login
  $( "#login" ).submit(function( event ) {
    event.preventDefault();

    var un = $("#name").val();
    var pw = $("#password").val();

    if(un === "" || pw === ""){
      return false;
    }
    //reset
    $("#name").val("");
    $("#password").val("");

    var loginPost = $.ajax
    ({
      type: "POST",
      url: "/login",
      dataType: 'json',
      async: false,
      headers: {
        "Authorization": "Basic " + btoa(un + ":" + pw)
      }
    });

    loginPost.always(function( data ) {
      if (loginPost.getResponseHeader('x-fantail-token') !== null) {
        localStorage.setItem('x-fantail-token',loginPost.getResponseHeader('x-fantail-token'));
        $('#auth').removeClass('visible').addClass('hidden');
        $('#app').removeClass('hidden').addClass('visible');
      }
    });

    return false;
  });
  /*
   * Narrative
   */
  $("#mood").submit(function(e) {
      e.preventDefault();

      console.log('mood data',e)
      if (!conn) {
          return false;
      }
      /*if (!mood.val()) {
          return false;
      }*/
      if (localStorage.getItem('x-fantail-token') === null) {
        return false;
      }

      /*console.log('saving mood ...');
      conn.send(JSON.stringify({
        type: 'wellbeing',
        user: localStorage.getItem('x-fantail-token'),
        data:{
          mood: mood.val()
        },
        time: new Date().toISOString()
      }));
      mood.val('');*/

      return false
  });
  $("#note").submit(function(e) {
      e.preventDefault();
      $('#note').removeClass('visible').addClass('hidden');
      if (!conn) {
          return false;
      }
      if (!note.val()) {
          return false;
      }
      if (localStorage.getItem('x-fantail-token') === null) {
        return false;
      }

      if (note.val()) {
        console.log('saving note ...');
        conn.send(JSON.stringify({
          type: 'note',
          user: localStorage.getItem('x-fantail-token'),
          data:{
            text: note.val()
          },
          time: new Date().toISOString()
        }));
        note.val('');
      }

      return false
  });
  $("#data").submit(function(e) {
      $('#data').removeClass('visible').addClass('hidden');
      e.preventDefault();
      if (!conn) {
          return false;
      }
      if (!smbg.val() && !note.val()) {
          return false;
      }
      if (localStorage.getItem('x-fantail-token') === null) {
        return false;
      }

      if (note.val()) {
        console.log('saving note ...');
        conn.send(JSON.stringify({
          type: 'note',
          user: localStorage.getItem('x-fantail-token'),
          data:{
            text: note.val()
          },
          time: new Date().toISOString()
        }));
        note.val('');
      }

      if (smbg.val()) {
        console.log('saving smbg ...');

        conn.send(JSON.stringify({
          type: 'smbg',
          user: localStorage.getItem('x-fantail-token'),
          data:{
            value: parseFloat(smbg.val()),
            units:'mmol/l'
          },
          time: new Date().toISOString()
        }));

        smbg.val('');
      }

      return false
  });
//setup
  if (window["WebSocket"]) {


    //start with `day`
    appendLog($("<p><i>Welcome back!</i></p>"))
    appendLog($("<p><i>How are things going?</i></p>"))
    $('#day').removeClass('hidden').addClass('visible');

    $('#mood').removeClass('visible').addClass('hidden');
    $('#note').removeClass('visible').addClass('hidden');
    $('#data').removeClass('visible').addClass('hidden');

    if (localStorage.getItem('x-fantail-token') !== null) {
      $('#auth').removeClass('visible').addClass('hidden');
      $('#app').removeClass('hidden').addClass('visible');
    } else {
      $('#auth').removeClass('hidden').addClass('visible');
      $('#app').removeClass('visible').addClass('hidden');
    }

    conn = new WebSocket("ws://{{$}}/ws/fantail");
    conn.onclose = function(evt) {
        appendLog($("<h2>Connection closed.</h2>"))
    }
    conn.onmessage = function(evt) {
        appendLog($("<div/>").text(evt.data))
        if (evt.data.indexOf("?") > -1) {
          $('#note').removeClass('hidden').addClass('visible');
        }
    }
  } else {
      appendLog($("<h2>Your browser does not support WebSockets.</h2>"))
  }
});
</script>
<style type="text/css">

input[type=submit]{background:#444;color:#fff;}
input{height:37px;margin:5px;font-size:18px;}
body{margin:40px auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}

.hidden{display: none;}
.visible{display:block;}
#data {position: absolute;bottom: 1em;}
#logout {position: absolute;top: 1em;}

</style>
</head>
<body>
  <div id="auth">
    <form id="login">
        <label for="name">Email</label>
        <input type="text" id="name" name="name">
        <label for="password">Password</label>
        <input type="password" id="password" name="password">
        <input type="submit" value="Login" />
    </form>
  </div>
  <div id="app">
    <p><a href="" id="logout">Logout</a></p>
    <div id="log"></div>
    <div id="notes">
      <form id="note">
        <input type="text" id="noteText">
        <input type="submit" value="Save It" />
        <input type="submit" value="Skip It" />
      </form>
    </div>
    <form id="mood">
        <input type="submit" id="happy" value="Happy" />
        <input type="submit" id="same" value="OK" />
        <input type="submit" id="unhappy" value="UnHappy" />
    </form>
    <form id="day">
        <input type="submit" id="good" value="Good" />
        <input type="submit" id="ok" value="OK" />
        <input type="submit" id="bad" value="Bad" />
    </form>
    <div>
      <form id="data">
        <input type="text" id="smbgText" placeholder="bg e.g. 10.7">
        <input type="submit" value="Save It" />
        <input type="submit" value="Skip It" />
      </form>
    </div>
  </div>
</body>
</html>
